{% extends "base.html" %}

{% block title %}Search Results - Invoice Processor{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-3">
        <div class="col">
            <h4 class="mb-0">
                <i class="bi bi-envelope-paper"></i> Gmail Search Results
            </h4>
            <p class="text-muted mb-0">
                Query: <code>{{ query }}</code>
                {% if date_from or date_to %}
                    | Date: {{ date_from or 'any' }} to {{ date_to or 'now' }}
                {% endif %}
            </p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('emails.search') }}" class="btn btn-outline-secondary">
                <i class="bi bi-search"></i> New Search
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h2 class="mb-0" id="totalAttachments">{{ summary.total_attachments }}</h2>
                    <small>Total Attachments</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h2 class="mb-0" id="pdfCount">{{ summary.pdf_count }}</h2>
                    <small>PDF Files</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h2 class="mb-0" id="imageCount">{{ summary.image_count }}</h2>
                    <small>Images</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h2 class="mb-0" id="totalSize">{{ format_size(summary.total_size) }}</h2>
                    <small>Total Size</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-danger" onclick="downloadAllPdfs()" id="downloadAllBtn" {% if summary.pdf_count == 0 %}disabled{% endif %}>
                    <i class="bi bi-file-earmark-pdf"></i> Download All PDFs (<span id="downloadAllCount">{{ summary.pdf_count }}</span>)
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="downloadSelected()" id="downloadSelectedBtn" disabled>
                    <i class="bi bi-download"></i> Download Selected (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    {% if messages %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Subject</th>
                            <th>From</th>
                            <th>Date</th>
                            <th>Attachments</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        {% for msg in messages %}
                        <tr>
                            <td>
                                {% for att in msg.attachments %}
                                    {% if att.mime_type == 'application/pdf' %}
                                    <input type="checkbox" class="form-check-input pdf-checkbox"
                                           data-attachment='{{ {"id": att.id, "message_id": att.message_id, "filename": att.filename, "size": att.size}|tojson }}'
                                           onchange="updateSelectedCount()">
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                <strong>{{ msg.subject|truncate(60) }}</strong>
                                <br>
                                <small class="text-muted">{{ msg.snippet|truncate(80) }}</small>
                            </td>
                            <td>
                                <small>{{ msg.from|truncate(30) }}</small>
                            </td>
                            <td>
                                <small>{{ msg.date }}</small>
                            </td>
                            <td>
                                {% for att in msg.attachments %}
                                <a href="{{ url_for('emails.view_attachment', message_id=att.message_id, attachment_id=att.id, filename=att.filename, mime_type=att.mime_type) }}"
                                   target="_blank"
                                   class="badge text-decoration-none {% if att.mime_type == 'application/pdf' %}bg-danger{% elif att.mime_type.startswith('image/') %}bg-success{% else %}bg-secondary{% endif %} me-1"
                                   title="Click to view {{ att.filename }}">
                                    {% if att.mime_type == 'application/pdf' %}
                                        <i class="bi bi-file-pdf"></i>
                                    {% elif att.mime_type.startswith('image/') %}
                                        <i class="bi bi-image"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark"></i>
                                    {% endif %}
                                    {{ att.filename|truncate(20) }}
                                    <small>({{ format_size(att.size) }})</small>
                                </a>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="text-center mt-4" id="loadMoreContainer">
        {% if next_page_token and next_page_token != '' %}
        <button type="button" class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMore()">
            <i class="bi bi-arrow-down"></i> Load More Results
        </button>
        {% else %}
        <p class="text-muted"><i class="bi bi-check-circle"></i> All results loaded</p>
        {% endif %}
    </div>

    {% else %}
    <div class="card shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">No emails with attachments found</h4>
            <p class="text-muted">Try adjusting your search query</p>
            <a href="{{ url_for('emails.search') }}" class="btn btn-primary mt-2">
                <i class="bi bi-search"></i> New Search
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Preparing download...</h5>
                <p class="text-muted mb-0">This may take a moment for large files.</p>
            </div>
        </div>
    </div>
</div>

<script>
let nextPageToken = '{{ next_page_token or "" }}';
let totalPdfCount = {{ summary.pdf_count }};

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.pdf-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.pdf-checkbox:checked');
    document.getElementById('selectedCount').textContent = checked.length;
    document.getElementById('downloadSelectedBtn').disabled = checked.length === 0;
}

function getSelectedAttachments() {
    const checked = document.querySelectorAll('.pdf-checkbox:checked');
    const attachments = [];
    checked.forEach(cb => {
        attachments.push(JSON.parse(cb.dataset.attachment));
    });
    return attachments;
}

function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function getAttachmentIcon(mimeType) {
    if (mimeType === 'application/pdf') return '<i class="bi bi-file-pdf"></i>';
    if (mimeType && mimeType.startsWith('image/')) return '<i class="bi bi-image"></i>';
    return '<i class="bi bi-file-earmark"></i>';
}

function getAttachmentClass(mimeType) {
    if (mimeType === 'application/pdf') return 'bg-danger';
    if (mimeType && mimeType.startsWith('image/')) return 'bg-success';
    return 'bg-secondary';
}

function loadMore() {
    if (!nextPageToken) return;

    const btn = document.getElementById('loadMoreBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Loading...';

    fetch(`/emails/load-more?page_token=${encodeURIComponent(nextPageToken)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            const tbody = document.getElementById('resultsBody');

            // Append new rows
            data.messages.forEach(msg => {
                const row = document.createElement('tr');

                // Checkbox cell
                let checkboxHtml = '<td>';
                msg.attachments.forEach(att => {
                    if (att.mime_type === 'application/pdf') {
                        const attData = JSON.stringify({id: att.id, message_id: att.message_id, filename: att.filename, size: att.size});
                        checkboxHtml += `<input type="checkbox" class="form-check-input pdf-checkbox" data-attachment='${attData}' onchange="updateSelectedCount()">`;
                        totalPdfCount++;
                    }
                });
                checkboxHtml += '</td>';

                // Subject cell
                const subjectHtml = `<td><strong>${truncateText(msg.subject, 60)}</strong><br><small class="text-muted">${truncateText(msg.snippet, 80)}</small></td>`;

                // From cell
                const fromHtml = `<td><small>${truncateText(msg.from, 30)}</small></td>`;

                // Date cell
                const dateHtml = `<td><small>${msg.date || ''}</small></td>`;

                // Attachments cell
                let attachmentsHtml = '<td>';
                msg.attachments.forEach(att => {
                    const badgeClass = getAttachmentClass(att.mime_type);
                    const icon = getAttachmentIcon(att.mime_type);
                    attachmentsHtml += `<a href="${att.view_url}" target="_blank" class="badge text-decoration-none ${badgeClass} me-1" title="Click to view ${att.filename}">${icon} ${truncateText(att.filename, 20)} <small>(${att.size_formatted})</small></a>`;
                });
                attachmentsHtml += '</td>';

                row.innerHTML = checkboxHtml + subjectHtml + fromHtml + dateHtml + attachmentsHtml;
                tbody.appendChild(row);
            });

            // Update next page token
            nextPageToken = data.next_page_token || '';

            // Update PDF count
            document.getElementById('downloadAllCount').textContent = totalPdfCount;
            document.getElementById('downloadAllBtn').disabled = totalPdfCount === 0;

            // Update load more button
            const container = document.getElementById('loadMoreContainer');
            if (nextPageToken) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-down"></i> Load More Results';
            } else {
                container.innerHTML = '<p class="text-muted"><i class="bi bi-check-circle"></i> All results loaded</p>';
            }
        })
        .catch(error => {
            console.error('Load more error:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-down"></i> Load More Results';
            alert('Failed to load more results: ' + error.message);
        });
}

function downloadSelected() {
    const attachments = getSelectedAttachments();
    if (attachments.length === 0) {
        alert('Please select at least one PDF');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();

    fetch('{{ url_for("emails.download") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ attachments: attachments })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.error); });
        }
        return response.blob();
    })
    .then(blob => {
        modal.hide();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email_attachments.zip';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    })
    .catch(error => {
        modal.hide();
        alert('Download failed: ' + error.message);
    });
}

function downloadAllPdfs() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();

    fetch('{{ url_for("emails.download_all_pdfs") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.error); });
        }
        return response.blob();
    })
    .then(blob => {
        modal.hide();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email_pdfs.zip';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    })
    .catch(error => {
        modal.hide();
        alert('Download failed: ' + error.message);
    });
}
</script>
{% endblock %}
